<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>News</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;max-width:980px;margin:40px auto;padding:0 16px;line-height:1.5}
    a{text-decoration:none}
    .top{display:flex;justify-content:space-between;align-items:baseline;gap:16px}
    .top h1{margin:0}
    .news-list{list-style:none;padding:0;margin:16px 0 0;border-top:1px solid #e5e5e5}
    .news-item{display:flex;gap:14px;align-items:flex-start;padding:12px 0;border-bottom:1px solid #e5e5e5}
    .news-date{min-width:110px;color:#666;font-variant-numeric:tabular-nums}
    .tag{display:inline-block;margin-left:8px;font-size:12px;padding:2px 8px;border:1px solid #ddd;border-radius:999px;color:#555}
  </style>
</head>
<body>
  <div class="top">
    <h1>News</h1>
    <a href="/">← Back to Home</a>
  </div>

  <ul id="newsAll" class="news-list" aria-label="All news"></ul>

<script>
  const NEWS_JSON = "/data/news.json";   // 用绝对路径最稳
  const NEWS_PAGE_PREFIX = "/news/";

  function fmtDate(iso) {
    const [y,m,d] = iso.split("-").map(Number);
    const dt = new Date(Date.UTC(y, m-1, d));
    return dt.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit", timeZone:"UTC" });
  }

  function todayFormatted() {
    const dt = new Date();
    return dt.toLocaleDateString(undefined, {
      year: "numeric",
      month: "long",
      day: "2-digit"
    });
  }

  function displayDate(it) {
    return (it && it.date) ? fmtDate(it.date) : todayFormatted();
  }

  async function loadAllNews() {
    const ul = document.getElementById("newsAll");
    try {
      const res = await fetch(NEWS_JSON, { cache: "no-store" });
      if (!res.ok) throw new Error(`Failed to fetch: ${res.status} ${res.statusText}`);

      const items = await res.json();
      if (!Array.isArray(items)) throw new Error("news.json must be an array: [ { ... }, ... ]");

      // 有 date 的按 date 倒序；没 date 的放最后
      items.sort((a, b) => ((b.date || "")).localeCompare(a.date || ""));

      ul.innerHTML = "";
      for (const it of items) {
        const li = document.createElement("li");
        li.className = "news-item";
        li.innerHTML = `
          <div class="news-date">${displayDate(it)}</div>
          <div>
            <a href="${NEWS_PAGE_PREFIX}${it.slug}.html">${it.title}</a>
            ${it.tag ? `<span class="tag">${it.tag}</span>` : ""}
          </div>
        `;
        ul.appendChild(li);
      }
    } catch (err) {
      ul.innerHTML = `
        <li class="news-item">
          <div class="news-date"></div>
          <div>Unable to load news. <span style="color:#888;">(${String(err.message || err)})</span></div>
        </li>`;
      console.error(err);
    }
  }

  loadAllNews();
</script>

</body>
</html>
